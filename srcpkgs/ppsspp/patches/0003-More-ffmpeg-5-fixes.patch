From 9920fd9bcf2807710b79eaf5c694f65b94fb54fe Mon Sep 17 00:00:00 2001
From: John Zimmermann <me@johnnynator.dev>
Date: Sat, 7 Jan 2023 00:16:17 +0100
Subject: [PATCH 3/3] More ffmpeg 5 fixes

---
 Core/HW/MediaEngine.cpp | 9 ++++++++-
 1 file changed, 8 insertions(+), 1 deletion(-)

diff --git a/Core/HW/MediaEngine.cpp b/Core/HW/MediaEngine.cpp
index 8e6870f0b..d602f5fac 100644
--- a/Core/HW/MediaEngine.cpp
+++ b/Core/HW/MediaEngine.cpp
@@ -37,7 +37,10 @@ extern "C" {
 #include "libavformat/avformat.h"
 #include "libavutil/imgutils.h"
 #include "libswscale/swscale.h"
-
+#if LIBAVFORMAT_VERSION_INT >= AV_VERSION_INT(59, 23, 100)
+	// private libavformat api
+	void avpriv_stream_set_need_parsing(AVStream *st, enum AVStreamParseType type);
+#endif
 }
 #endif // USE_FFMPEG
 
@@ -434,7 +437,11 @@ bool MediaEngine::addVideoStream(int streamNum, int streamId) {
 #else
 			stream->request_probe = 0;
 #endif
+#if LIBAVFORMAT_VERSION_INT >= AV_VERSION_INT(59, 23, 100)
+			avpriv_stream_set_need_parsing(stream, AVSTREAM_PARSE_FULL);
+#else
 			stream->need_parsing = AVSTREAM_PARSE_FULL;
+#endif
 			// We could set the width here, but we don't need to.
 			if (streamNum >= m_expectedVideoStreams) {
 				++m_expectedVideoStreams;
-- 
2.39.0

