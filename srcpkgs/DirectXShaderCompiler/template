# Template file for 'DirectXShaderCompiler'
pkgname=DirectXShaderCompiler
version=1.7.2212.1
revision=1
archs="x86_64* i686*"
build_style=cmake
configure_args="-C ../cmake/caches/PredefinedParams.cmake"
hostmakedepends="python3 git"
short_desc="DirectX Shader Compiler based on LLVM/Clang. "
maintainer="Joshua Woodie <joshua.t.woodie@gmail.com>"
license="LLVM"
homepage="https://github.com/microsoft/DirectXShaderCompiler"
_SPIRV_Headers_commit=1d31a100405cf8783ca7a31e31cdd727c9fc54c3
_SPIRV_Tools_commit=40f5bf59c6acb4754a0bffd3c53a715732883a12
_re2_commit=4be240789d5b322df9f02b7e19c8651f3ccbf205
_effcee_commit=35912e1b7778ec2ddcff7e7188177761539e59e0
_DirectX_Headers_commit=980971e835876dc0cde415e8f9bc646e64667bf7
distfiles="https://github.com/microsoft/DirectXShaderCompiler/archive/refs/tags/v${version}.tar.gz
 https://github.com/KhronosGroup/SPIRV-Headers/archive/${_SPIRV_Headers_commit}.tar.gz
 https://github.com/KhronosGroup/SPIRV-Tools/archive/${_SPIRV_Tools_commit}.tar.gz
 https://github.com/google/re2/archive/${_re2_commit}.tar.gz
 https://github.com/google/effcee/archive/${_effcee_commit}.tar.gz
 https://github.com/microsoft/DirectX-Headers/archive/${_DirectX_Headers_commit}.tar.gz"
checksum="f345a555aa02d16cf2ac6e6e72bf340f20626849ece6ba3700ae17a1ca6fc6b7
 ec09b682c93bffc6e3d58459840a0306b6b9360e56e797c4243d2d7b785dea74
 b99c91307a4b466754ffeaaaa6086bda55780ccf1557592004a1736fb9aa7ce7
 da5c23ecdb9a55c82d6802ee55812dfb99a035a4838287c0b7c0051bd0fdb9fc
 3e9d106b8cb018db6dffb3f38748f6b162266b5307433fe36d0af26bb236befb
 b5a4b6d8806ff7f29f19879f83d015dbe8740676d4ca0b48647a789cc7773c4e"

skip_extraction="
 ${_SPIRV_Headers_commit}.tar.gz
 ${_SPIRV_Tools_commit}.tar.gz
 ${_re2_commit}.tar.gz
 ${_effcee_commit}.tar.gz
 "

if [ "$XBPS_TARGET_LIBC" = "musl" ]; then
	# Tests on musl would require some patching to be done
	# Also some fun with Mutexes. so mt is disabled for now
	configure_args+=" -DCLANG_INCLUDE_TESTS=FALSE -DHLSL_INCLUDE_TESTS=FALSE -DLLVM_ENABLE_THREADS=OFF"
fi
nocross="fun with cmake and bunlded llvm"

post_extract() {
	vsrcextract -C external/SPIRV-Headers ${_SPIRV_Headers_commit}.tar.gz
	vsrcextract -C external/SPIRV-Tools ${_SPIRV_Tools_commit}.tar.gz
	vsrcextract -C external/re2 ${_re2_commit}.tar.gz
	vsrcextract -C external/effcee ${_effcee_commit}.tar.gz
}

do_install() {
	for f in build/lib/libdxcompiler.so*; do
		vinstall $f 644 usr/lib
	done
	vbin build/bin/dxc
	vmkdir usr/include
	vcopy include/dxc usr/include/
	vlicense LICENSE.TXT
	vlicense ThirdPartyNotices.txt
}

DirectXShaderCompiler-devel_package() {
	short_desc+="${short_desc} - development files"
	depends="${sourcepkg}>=${version}_${revision}"
	pkg_install() {
		vmove usr/include
		vmove usr/bin/dxc
	}
}
